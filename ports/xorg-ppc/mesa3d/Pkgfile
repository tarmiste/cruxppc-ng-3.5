# Description: Mesa 3D Graphics Library
# URL: http://www.mesa3d.org
# Maintainer: CRUX Xorg Team, xorg-ports at crux dot nu
# Depends on: elfutils libdrm libglvnd libvdpau llvm python3-mako xorg-libxdamage xorg-libxrandr xorg-libxshmfence xorg-libxvmc xorg-libxxf86vm

# WIP:   This needs work.

name=mesa3d
version=19.0.8
release=1
source=(https://mesa.freedesktop.org/archive/mesa-$version.tar.xz)

build() {
	cd mesa-$version

	meson build \
		--prefix=/usr \
		--sysconfdir=/etc \
		-Dllvm=false \
		-Dgbm=true \
		-Dgles1=false \
		-Dgles2=true \
		-Dosmesa=none \
		-Dgallium-xa=false \
		-Dgallium-vdpau=false \
		-Dgallium-nine=false \
		-Dgallium-va=false \
		-Dgallium-xvmc=false \
		-Dgallium-opencl=disabled \
		-Dplatforms=x11,surfaceless,drm \
		-Ddri3=true \
		-Ddri-drivers=r100,r200 \
		-Dgallium-drivers=r300,r600,swrast \
		-Dvulkan-drivers= \
		-Dglvnd=false \
		-Dglx=dri \
		-Dlmsensors=false \
		-Dlibunwind=false \
		-Dbuild-tests=false \
		-Dshared-glapi=true \
		-Degl=true 

	DESTDIR=$PKG ninja -C build -j ${JOBS:-1} install

	# indirect rendering symlink
	ln -s libGLX_mesa.so.0 $PKG/usr/lib/libGLX_indirect.so.0

	# remove libGLES* for libglvnd; see thread at
	# https://lists.freedesktop.org/archives/mesa-maintainers/2017-March/000055.html
	rm $PKG/usr/lib/libGLES*
}
